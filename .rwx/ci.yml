on:
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
  github:
    push:
      init:
        commit-sha: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/rwx-cloud/ci-examples
      ref: ${{ init.commit-sha }}

  - key: node
    call: nodejs/install 1.1.11
    with:
      node-version: "24.8.0"

  - key: node-modules
    use: [code, node]
    run: npm install
    filter:
      - package.json
      - package-lock.json

  - key: docker-images
    use: code
    docker: preserve-data
    run: docker compose pull
    filter:
      - docker-compose.yml

  - key: test
    use: [node-modules, docker-images]
    docker: true
    background-processes:
      - key: postgres-redis
        run: docker compose up
        ready-check: rwx-docker-ready-check
    run: npm test -- --json --outputFile=test-results.json
    outputs:
      test-results:
        - path: test-results.json

  - key: lint
    use: node-modules
    run: npm run lint
    outputs:
      problems:
        - matcher: eslint

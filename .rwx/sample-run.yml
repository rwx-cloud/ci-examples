on:
  github:
    push:
      if: ${{ event.git.branch == 'main' }}
      init:
        commit-sha: ${{ event.git.sha }}

base:
  os: ubuntu 24.04
  tag: 1.1

tasks:
  - key: code
    call: git/clone 1.6.9
    with:
      repository: https://github.com/rwx-cloud/ci-examples
      ref: ${{ init.commit-sha }}

  - key: node
    call: nodejs/install 1.1.9
    with:
      node-version: "24.8.0"

  - key: node-modules
    use: [code, node]
    agent:
      tmpfs: true
    run: npm install
    filter:
      - package.json
      - package-lock.json

  - key: docker-images
    use: code
    docker: preserve-data
    run: docker compose pull
    filter:
      - docker-compose.yml

  - key: example-tests
    use: [node-modules, docker-images]
    docker: true
    background-processes:
      - key: postgres-redis
        run: docker compose up
        ready-check: rwx-docker-ready-check
    run: npm test -- --json --outputFile=test-results.json
    outputs:
      test-results:
        - path: test-results.json

  - key: example-lint-failures
    use: node-modules
    run: npm run lint
    outputs:
      problems:
        - matcher: eslint
